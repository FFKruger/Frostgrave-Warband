<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Frostgrave Warband Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eaf2f8; margin: 0; }
        main { max-width: 1100px; margin: 2em auto 2em auto; background: #fff; border-radius: 10px; padding: 2em 2.5em; box-shadow: 0 6px 28px #bbb8; }
        h1 { text-align: center; margin-bottom: 0.7em; }
        h2 { color: #2e4053; }
        nav { text-align: center; margin-bottom: 1.5em; }
        nav button { background: #eaf2f8; border: 1px solid #bbb; border-radius: 8px 8px 0 0; padding: 0.7em 2em; font-size: 1.1em; margin-right: 0.2em; cursor: pointer;}
        nav button.active, nav button:hover { background: #3498db; color: #fff;}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .vertical-list { display: flex; flex-direction: column; gap: 1.5em; margin-bottom: 2em; }
        .person-card {
            background: #fafdff;
            border-radius: 10px;
            box-shadow: 0 1px 8px #bbb3;
            padding: 1.3em 1.1em 1em 1.1em;
            width: 100%;
            position: relative;
            margin-bottom: 0;
        }
        .person-header { font-size: 1.16em; margin-bottom: .7em;}
        .tipo-mago { color: #1a5276; font-weight: bold; }
        .tipo-aprendiz { color: #8e44ad; font-weight: bold; }
        .tipo-soldado { color: #16a085; font-weight: bold; }
        .soldado-elite { color: #c0392b; }
        .stats-line { display: flex; align-items: center; gap: 1.25em; margin-bottom: .6em; padding: 0.6em 0; background: #f2f7fa; border-radius: 6px;}
        .stat-label { font-weight: 600; margin-right: 0.2em; color: #2c3e50;}
        .stat-value, .stat-input { width: 2.2em; text-align: center; }
        .stat-input { border: 1px solid #bbb; border-radius: 5px; font-size: 1em; padding: 0.1em 0.2em;}
        .hp-box { display: flex; align-items: center; gap: 0.2em;}
        .hp-btn { background: #3498db; color: #fff; border: none; border-radius: 5px; font-size: 1.1em; width: 2em; height: 2em; cursor: pointer;}
        .hp-btn:active { background: #2471a3; }
        .hp-value { width: 2.3em; text-align: center; font-size: 1.09em; border: 1px solid #bbb; border-radius: 5px; margin: 0 0.2em;}
        .remove-btn { margin-left: 4px; background: #c0392b; color: #fff; border: none; border-radius: 5px; font-size: 0.97em; padding: 0.18em 0.7em; cursor: pointer; }
        .remove-btn:active { background: #922b21; }
        .notes-box { width: 100%; min-height: 80px; border-radius:6px; border: 1px solid #bbb; padding: .7em; font-size: 1.07em; margin-bottom: 1em;}
        .add-form select { min-width: 160px; }
        .add-mago-aprendiz-btns { margin-bottom: 2em; }
        .add-mago-aprendiz-btns button { margin-right: 1em; background: #3498db; color: #fff; font-weight: bold; border: none; border-radius: 7px; padding: 0.6em 1.4em; font-size: 1em; cursor: pointer;}
        .add-mago-aprendiz-btns button:last-child { margin-right: 0;}
        .add-mago-aprendiz-btns button:active { background: #2471a3; }
        .add-form-soldado { margin-bottom: 2em;}
        .badge-limit { display:inline-block; background: #d35400; color:#fff; font-size:0.9em; border-radius:5px; padding: 0 .4em; margin-left:.5em; }
        .badge-el { background: #c0392b; }
        .badge-norm { background: #3498db;}
        .soldado-limit-alert {color:#c0392b;font-weight:bold; margin-bottom:1em;}
        .magias-list, .itens-list { margin: 0.4em 0 0 1.2em; font-size: 0.97em; }
        .person-magias { margin-top: 0.5em; padding-left: 1.1em; color: #1a5276; font-size: 0.98em; }
        .magia-form, .item-form { margin-bottom: 1.2em; }
        .magia-form select, .item-form select { min-width: 200px; margin-right: 1em;}
        /* Bestiário */
        .beast-card, .active-beast-card { margin-bottom: 1.2em;}
        .beast-header { font-size: 1.13em; font-weight: bold; margin-bottom: .5em; }
        .beast-type { color: #c0392b; font-weight: bold; }
        .beast-desc { color: #222; font-size: 0.98em; font-style: italic; margin-bottom: .7em;}
        .select-beast-btn { position: absolute; top: 10px; right: 10px; background: #e67e22; color: #fff; border: none; border-radius: 5px; font-size: 0.97em; padding: 0.18em 0.7em; cursor: pointer;}
        .select-beast-btn.selected { background: #229954; }
        .beast-tooltip { position: relative; cursor: help; border-bottom: 1px dotted #aaa; }
        .beast-tooltip .tooltiptext {
            visibility: hidden;
            width: 265px;
            background-color: #222;
            color: #fff;
            text-align: left;
            border-radius: 9px;
            padding: 0.7em 1em;
            position: absolute;
            z-index: 10;
            top: 145%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.22s;
            font-size: 1em;
            box-shadow: 0 3px 18px #0008;
        }
        .beast-tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .bestiary-list { margin-top: 1.2em; }
        .bestiary-group { margin-bottom: 2.5em; }
        .bestiary-group h3 { color: #c0392b; margin-bottom: 0.7em; }
        .active-beasts-list { display: flex; flex-direction: column; gap: 1.2em; margin-bottom: 2em; }
        @media (max-width: 700px) {
            main { padding: 0.5em 0.3em; }
        }
    </style>
</head>
<body>
<main>
    <h1>Frostgrave Warband Manager</h1>
    <nav id="tabnav">
        <button data-tab="dashboard" class="active" type="button">Dashboard</button>
        <button data-tab="magias" type="button">Magias</button>
        <button data-tab="itens" type="button">Itens</button>
        <button data-tab="notas" type="button">Notas</button>
        <button data-tab="bestiario" type="button">Bestiário</button>
    </nav>
    <section id="dashboard" class="tab-content active">
        <h2>Mago & Aprendiz</h2>
        <div class="vertical-list" id="mago-aprendiz-lista"></div>
        <div class="add-mago-aprendiz-btns" id="add-mago-aprendiz-btns"></div>
        <h2>Soldados</h2>
        <div class="vertical-list" id="soldado-lista"></div>
        <section class="add-section">
            <h2>Adicionar Soldado</h2>
            <div class="soldado-limit-alert" id="soldado-limit-alert"></div>
            <form class="add-form add-form-soldado" id="add-soldado-form">
                <label>
                    Tipo de Soldado:
                    <select id="soldado-tipo"></select>
                </label>
                <label>
                    Nome:
                    <input id="soldado-nome" type="text" maxlength="40" placeholder="Opcional">
                </label>
                <button type="submit">Adicionar Soldado</button>
            </form>
        </section>
    </section>
    <section id="magias" class="tab-content">
        <h2>Banco de Magias</h2>
        <form class="magia-form" id="add-magia-form">
            <select id="magia-dropdown"></select>
            <input id="magia-comp" type="text" placeholder="Descrição completa (opcional)">
            <button type="submit">Adicionar Magia</button>
        </form>
        <ul id="banco-magias-lista" class="magias-list"></ul>
    </section>
    <section id="itens" class="tab-content">
        <h2>Banco de Itens</h2>
        <form class="item-form" id="add-item-form">
            <select id="item-dropdown"></select>
            <input id="item-efeito" type="text" placeholder="Efeito extra (opcional)">
            <button type="submit">Adicionar Item</button>
        </form>
        <ul id="banco-itens-lista" class="itens-list"></ul>
    </section>
    <section id="notas" class="tab-content">
        <h2>Anotações da Warband</h2>
        <textarea class="notes-box" id="notas-box" placeholder="Anote estratégias, progresso, tesouros, eventos..."></textarea>
    </section>
    <section id="bestiario" class="tab-content">
        <h2>Bestiário</h2>
        <div id="active-beasts-list" class="active-beasts-list"></div>
        <div id="bestiary-list" class="bestiary-list"></div>
    </section>
</main>
<script>
let personagens = [];
let bancoMagias = [];
let bancoItens = [];
let magiasPorPersonagem = {};
let bestiarioAtivo = [];
let ESCOLAS = [];
let magiasPorEscola = {};
let itensPadrao = {};
let STATS = {};
let SOLDADOS_NORMAIS = [];
let SOLDADOS_ELITES = [];
let ITEM_LIMITS = { "Mago": 5, "Aprendiz": 1, "Soldado": 1 };
let bestiario = [];

function fetchConteudoFrostgrave() {
    return fetch('conteudo_frostgrave.json')
        .then(r => r.json())
        .then(data => {
            ESCOLAS = data.escolas;
            magiasPorEscola = {};
            data.magias.forEach(m => {
                if (!magiasPorEscola[m.escola]) magiasPorEscola[m.escola] = [];
                magiasPorEscola[m.escola].push(m);
            });
            itensPadrao = {};
            data.itens.forEach(i => {
                if (!itensPadrao[i.grupo]) itensPadrao[i.grupo] = [];
                itensPadrao[i.grupo].push(i);
            });
            STATS = {};
            SOLDADOS_NORMAIS = [];
            SOLDADOS_ELITES = [];
            data.personagens.forEach(p => {
                STATS[p.tipo] = p.stats;
                if (["Thief", "Thug", "War Dog", "Infantryman", "Man-at-Arms"].includes(p.tipo))
                    SOLDADOS_NORMAIS.push(p.tipo);
                else if (!["Mago", "Aprendiz"].includes(p.tipo))
                    SOLDADOS_ELITES.push(p.tipo);
            });
            bestiario = [
                {nome:"Giant Rat", tipo:"Animal", desc:"Roedor agressivo e rápido.", explicacao:"Geralmente aparecem em grupos. Pequenos, mas podem causar problemas se ignorados.", stats:{move:7, fight:"+0", shoot:"-", armor:8, will:"-1", hp:6}},
                {nome:"Bear", tipo:"Animal", desc:"Urso feroz.", explicacao:"Alto dano em combate, resistente.", stats:{move:6, fight:"+4", shoot:"-", armor:12, will:"0", hp:16}},
                {nome:"Skeleton", tipo:"Morto-vivo", desc:"Guarda esquelético, imune a venenos.", explicacao:"Imune a veneno, não pode ser curado.", stats:{move:6, fight:"+1", shoot:"-", armor:12, will:"+0", hp:10}},
                {nome:"Zombie", tipo:"Morto-vivo", desc:"Lento mas persistente.", explicacao:"Muito difícil de derrubar, não pode correr.", stats:{move:4, fight:"+0", shoot:"-", armor:12, will:"-2", hp:12}}
            ];
        });
}

// ============== RENDER DASHBOARD ==============
function renderMagoAprendizSection() {
    const div = document.getElementById('mago-aprendiz-lista');
    div.innerHTML = '';
    let magoIdx = personagens.findIndex(p => p.tipo === "Mago");
    let aprendizIdx = personagens.findIndex(p => p.tipo === "Aprendiz");
    if (magoIdx !== -1) div.appendChild(personagemCard(personagens[magoIdx], magoIdx));
    if (aprendizIdx !== -1) div.appendChild(personagemCard(personagens[aprendizIdx], aprendizIdx));
    // Botões de adicionar
    const btnDiv = document.getElementById('add-mago-aprendiz-btns');
    btnDiv.innerHTML = '';
    if (magoIdx === -1) {
        let sel = `<select id="escola-mago" style="margin-right:1em;">
            ${ESCOLAS.map(e=>`<option value="${e}">${e}</option>`).join('')}
        </select>`;
        btnDiv.innerHTML +=
            `<button id="add-mago-btn">+ Adicionar Mago</button> ${sel}`;
    }
    if (aprendizIdx === -1) {
        let sel = `<select id="escola-aprendiz" style="margin-right:1em;">
            ${ESCOLAS.map(e=>`<option value="${e}">${e}</option>`).join('')}
        </select>`;
        btnDiv.innerHTML +=
            `<button id="add-aprendiz-btn">+ Adicionar Aprendiz</button> ${sel}`;
    }
    if (document.getElementById("add-mago-btn")) document.getElementById("add-mago-btn").onclick = adicionarMago;
    if (document.getElementById("add-aprendiz-btn")) document.getElementById("add-aprendiz-btn").onclick = adicionarAprendiz;
}
function renderSoldadosSection() {
    const soldadoDiv = document.getElementById('soldado-lista');
    soldadoDiv.innerHTML = '';
    personagens
        .filter(p => p.tipo === "Soldado")
        .forEach((pers, idx) => soldadoDiv.appendChild(personagemCard(pers, idx)));
    renderSoldadoDropdown();
    renderSoldadoAlert();
}
function renderPersonagens() {
    renderMagoAprendizSection();
    renderSoldadosSection();
}
function personagemCard(pers, idx) {
    let tipoStr = pers.tipo;
    let stats = getStats(pers);
    let name = pers.nome || pers.tipoSoldado || "";
    if (pers.tipo === "Mago") tipoStr = `<span class="tipo-mago">Mago</span>`;
    else if (pers.tipo === "Aprendiz") tipoStr = `<span class="tipo-aprendiz">Aprendiz</span>`;
    else if (SOLDADOS_NORMAIS.includes(pers.tipoSoldado)) tipoStr = `<span class="tipo-soldado">${pers.tipoSoldado}</span>`;
    else tipoStr = `<span class="soldado-elite">${pers.tipoSoldado||pers.tipo}</span>`;

    let hpAtual = typeof pers.hpAtual === 'number' ? pers.hpAtual : stats.hp;
    if(!pers.itens) pers.itens = [];
    let itemLimit = ITEM_LIMITS[pers.tipo] || ITEM_LIMITS["Soldado"];
    let podeAdicionarItem = pers.itens.length < itemLimit;
    let opcoesItens = bancoItens.map((i, iidx) =>
        `<option value="${iidx}">${i.nome}</option>`
    ).join('');
    let itensHtml = pers.itens.length
        ? `<ul class="itens-list" style="margin-top:0.4em;">${
            pers.itens.map((item, iidx) =>
                `<li>${item.nome || "Item"}<button class="remove-btn" onclick="removerItemPersonagem(${idx},${iidx})" title="Remover item">✖</button></li>`
            ).join('')
        }</ul>`
        : "<div style='color:#aaa; font-size:.98em;'>Nenhum item</div>";
    let addItemForm = bancoItens.length && podeAdicionarItem
        ? `<form onsubmit="adicionarItemPersonagem(event,${idx})" style="margin-top:0.6em;">
            <select name="item">${opcoesItens}</select>
            <button type="submit">Adicionar Item</button>
            <span style="font-size:.92em;color:#888;">(${pers.itens.length}/${itemLimit})</span>
        </form>`
        : `<span style="font-size:.92em;color:#888;">Limite de itens: ${itemLimit}</span>`;

    let editableStats = '';
    if (pers.tipo === "Mago") {
        editableStats = `
        <div class="stats-line">
            <span class="stat-label">Mov:</span><input class="stat-input" type="number" step="1" value="${stats.move}" onchange="editarStat(${idx},'move',this.value)">
            <span class="stat-label">Fight:</span><input class="stat-input" type="text" value="${stats.fight}" onchange="editarStat(${idx},'fight',this.value)">
            <span class="stat-label">Shoot:</span><input class="stat-input" type="text" value="${stats.shoot}" onchange="editarStat(${idx},'shoot',this.value)">
            <span class="stat-label">Armor:</span><input class="stat-input" type="number" step="1" value="${stats.armor}" onchange="editarStat(${idx},'armor',this.value)">
            <span class="stat-label">Will:</span><input class="stat-input" type="text" value="${stats.will}" onchange="editarStat(${idx},'will',this.value)">
            <span class="stat-label">HP:</span>
            <span class="hp-box">
                <button class="hp-btn" onclick="alteraHP(${idx},-1);return false;">-</button>
                <input class="hp-value" type="number" min="0" max="99" value="${hpAtual}" onchange="setHP(event,${idx})">
                <button class="hp-btn" onclick="alteraHP(${idx},1);return false;">+</button>
            </span>
        </div>
        `;
    } else if (pers.tipo === "Aprendiz") {
        editableStats = `
        <div class="stats-line">
            <span class="stat-label">Mov:</span><span class="stat-value">${stats.move}</span>
            <span class="stat-label">Fight:</span><span class="stat-value">${stats.fight}</span>
            <span class="stat-label">Shoot:</span><span class="stat-value">${stats.shoot}</span>
            <span class="stat-label">Armor:</span><span class="stat-value">${stats.armor}</span>
            <span class="stat-label">Will:</span><span class="stat-value">${stats.will}</span>
            <span class="stat-label">HP:</span>
            <span class="hp-box">
                <button class="hp-btn" onclick="alteraHP(${idx},-1);return false;">-</button>
                <input class="hp-value" type="number" min="0" max="99" value="${hpAtual}" onchange="setHP(event,${idx})">
                <button class="hp-btn" onclick="alteraHP(${idx},1);return false;">+</button>
            </span>
        </div>
        `;
    } else {
        editableStats = `
        <div class="stats-line">
            <span class="stat-label">Mov:</span><span class="stat-value">${stats.move}</span>
            <span class="stat-label">Fight:</span><span class="stat-value">${stats.fight}</span>
            <span class="stat-label">Shoot:</span><span class="stat-value">${stats.shoot}</span>
            <span class="stat-label">Armor:</span><span class="stat-value">${stats.armor}</span>
            <span class="stat-label">Will:</span><span class="stat-value">${stats.will}</span>
            <span class="stat-label">HP:</span>
            <span class="hp-box">
                <button class="hp-btn" onclick="alteraHP(${idx},-1);return false;">-</button>
                <input class="hp-value" type="number" min="0" max="99" value="${hpAtual}" onchange="setHP(event,${idx})">
                <button class="hp-btn" onclick="alteraHP(${idx},1);return false;">+</button>
            </span>
        </div>
        `;
    }

    return Object.assign(document.createElement('div'), {
        className: 'person-card',
        innerHTML: `
        <div class="person-header">
            ${tipoStr} ${name ? ' - ' + name : ''}
            <button class="remove-btn" title="Remover" onclick="removerPersonagem(${idx})">✖</button>
        </div>
        ${editableStats}
        <div style="margin-top:0.6em;">
            <b>Itens:</b> ${addItemForm}
            ${itensHtml}
        </div>
        ${renderPersonagemMagias(idx)}
        `
    });
}

function getStats(pers) {
    if (pers.tipo === "Aprendiz") {
        let mago = personagens.find(p => p.tipo === "Mago");
        if (!mago || !mago.stats) return {...STATS["Aprendiz"]};
        const m = mago.stats;
        let stat = val => {
            let n = parseInt(val); if (isNaN(n)) n = 0;
            return n;
        };
        let fightA = (stat(m.fight) - 2 >= -2 ? (stat(m.fight) - 2) : -2);
        let willA = (stat(m.will) - 2 >= -2 ? (stat(m.will) - 2) : -2);
        return {
            move: m.move,
            fight: (fightA >= 0 ? "+" + fightA : fightA),
            shoot: m.shoot,
            armor: m.armor,
            will: (willA >= 0 ? "+" + willA : willA),
            hp: 10
        };
    }
    if (pers.tipo === "Mago") {
        return pers.stats || {...STATS["Mago"]};
    }
    return STATS[pers.tipo] || STATS[pers.tipoSoldado] || {move:"-",fight:"-",shoot:"-",armor:"-",will:"-",hp:"-"};
}
window.editarStat = function(idx, campo, valor) {
    let p = personagens[idx];
    if (!p.stats) p.stats = {...STATS["Mago"]};
    if (campo === "move" || campo === "armor" || campo === "hp") {
        p.stats[campo] = parseInt(valor) || 0;
    } else {
        p.stats[campo] = valor;
    }
    renderPersonagens();
};
// ... (demais funções do exemplo anterior: dashboard, magias, itens, bestiário, abas, etc) ...
// Insira todas as funções JS já adaptadas dos exemplos anteriores aqui (omitidas por brevidade).
// O restante do código permanece igual, apenas acrescente as funções acima!

window.onload = function() {
    fetchConteudoFrostgrave().then(() => {
        renderPersonagens();
        renderBestiario();
        renderMagiaDropdown();
        renderBancoMagias();
        renderItemDropdown();
        renderBancoItens();
    });

    document.getElementById('add-soldado-form').addEventListener('submit', adicionarSoldadoHandler);
    document.getElementById('add-magia-form').addEventListener('submit', adicionarBancoMagiaHandler);
    document.getElementById('add-item-form').addEventListener('submit', adicionarBancoItemHandler);
};
</script>
</body>
</html>
