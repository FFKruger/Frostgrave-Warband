<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Frostgrave Warband Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eaf2f8; margin: 0; }
        main { max-width: 1100px; margin: 2em auto 2em auto; background: #fff; border-radius: 10px; padding: 2em 2.5em; box-shadow: 0 6px 28px #bbb8; }
        h1 { text-align: center; margin-bottom: 0.7em; }
        h2 { color: #2e4053; }
        nav { text-align: center; margin-bottom: 1.5em; }
        nav button { background: #eaf2f8; border: 1px solid #bbb; border-radius: 8px 8px 0 0; padding: 0.7em 2em; font-size: 1.1em; margin-right: 0.2em; cursor: pointer;}
        nav button.active, nav button:hover { background: #3498db; color: #fff;}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .flex-wrap { display: flex; flex-wrap: wrap; gap: 2em; margin-bottom: 2em; }
        .person-card { background: #fafdff; border-radius: 10px; box-shadow: 0 1px 8px #bbb3; padding: 1.3em 1.1em 1em 1.1em; min-width: 350px; flex: 1 1 390px; position: relative; margin-bottom: 1.3em;}
        .person-header { font-size: 1.16em; margin-bottom: .7em;}
        .tipo-mago { color: #1a5276; font-weight: bold; }
        .tipo-aprendiz { color: #8e44ad; font-weight: bold; }
        .tipo-soldado { color: #16a085; font-weight: bold; }
        .stats-line { display: flex; align-items: center; gap: 1.25em; margin-bottom: .6em; padding: 0.6em 0; background: #f2f7fa; border-radius: 6px;}
        .stat-label { font-weight: 600; margin-right: 0.2em; color: #2c3e50;}
        .stat-value { width: 2.2em; text-align: center; }
        .hp-box { display: flex; align-items: center; gap: 0.2em;}
        .hp-btn { background: #3498db; color: #fff; border: none; border-radius: 5px; font-size: 1.1em; width: 2em; height: 2em; cursor: pointer;}
        .hp-btn:active { background: #2471a3; }
        .hp-value { width: 2.3em; text-align: center; font-size: 1.09em; border: 1px solid #bbb; border-radius: 5px; margin: 0 0.2em;}
        .name-value { width: 7em; }
        .label { font-weight: 500; color: #444; }
        .remove-btn { margin-left: 4px; background: #c0392b; color: #fff; border: none; border-radius: 5px; font-size: 0.97em; padding: 0.18em 0.7em; cursor: pointer; }
        .remove-btn:active { background: #922b21; }
        .magia-add-btn, .item-add-btn { background: #16a085; color: #fff; border: none; border-radius: 3px; padding: 0.13em 0.7em; margin-left: 0.5em; cursor: pointer; font-size: 0.97em;}
        .magia-add-btn:active, .item-add-btn:active { background: #14806d;}
        .magias-list, .itens-list { margin: 0.4em 0 0 1.2em; font-size: 0.97em; }
        .magia-tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #aaa;
        }
        .magia-tooltip .tooltiptext, .item-tooltip .tooltiptext {
            visibility: hidden;
            width: 340px;
            background-color: #222;
            color: #fff;
            text-align: left;
            border-radius: 9px;
            padding: 0.8em 1em;
            position: absolute;
            z-index: 10;
            bottom: 115%;
            left: 50%;
            margin-left: -170px;
            opacity: 0;
            transition: opacity 0.22s;
            font-size: 1em;
            box-shadow: 0 3px 18px #0008;
        }
        .magia-tooltip:hover .tooltiptext,
        .item-tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .item-tooltip { position: relative; cursor: help; border-bottom: 1px dotted #aaa; }
        .actions-row { margin-top: 1.2em; }
        .notes-box { width: 100%; min-height: 80px; border-radius:6px; border: 1px solid #bbb; padding: .7em; font-size: 1.07em; margin-bottom: 1em;}
        .add-form select { min-width: 160px; }
        .mago-link { color: #3498db; text-decoration: underline; cursor: pointer; font-weight: bold; }
        .mago-link.active { color: #1a5276; }
        .personagem-destacado { border: 2px solid #3498db !important; background: #e8f4fb !important; }
        .mago-seletor { margin-bottom: 1.1em; }
        .add-mago-aprendiz-btns { margin-bottom: 2em; }
        .add-mago-aprendiz-btns button { margin-right: 1em; background: #3498db; color: #fff; font-weight: bold; border: none; border-radius: 7px; padding: 0.6em 1.4em; font-size: 1em; cursor: pointer;}
        .add-mago-aprendiz-btns button:last-child { margin-right: 0;}
        .add-mago-aprendiz-btns button:active { background: #2471a3; }
        .add-form-soldado { margin-bottom: 2em;}
        .badge-limit { display:inline-block; background: #d35400; color:#fff; font-size:0.9em; border-radius:5px; padding: 0 .4em; margin-left:.5em; }
        .badge-el { background: #c0392b; }
        .badge-norm { background: #3498db;}
        .soldado-limit-alert {color:#c0392b;font-weight:bold; margin-bottom:1em;}
        @media (max-width: 1100px) { .flex-wrap { flex-direction: column; } .person-card { min-width: unset; width: 100%; } }
    </style>
</head>
<body>
<main>
    <h1>Frostgrave Warband Manager</h1>
    <nav>
        <button class="active" onclick="showTab('dashboard')">Dashboard</button>
        <button onclick="showTab('magias')">Magias</button>
        <button onclick="showTab('itens')">Itens</button>
        <button onclick="showTab('notas')">Notas</button>
    </nav>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab-content active">
        <h2>Magos & Aprendiz</h2>
        <ul class="flex-wrap" id="mago-aprendiz-lista"></ul>
        <div class="add-mago-aprendiz-btns">
            <button onclick="adicionarMago()">+ Adicionar Mago</button>
            <button onclick="adicionarAprendiz()">+ Adicionar Aprendiz</button>
        </div>
        <h2>Soldados</h2>
        <ul class="flex-wrap" id="soldado-lista"></ul>
        <section class="add-section">
            <h2>Adicionar Soldado</h2>
            <div class="soldado-limit-alert" id="soldado-limit-alert"></div>
            <form class="add-form add-form-soldado" id="add-soldado-form">
                <label>
                    Tipo de Soldado:
                    <select id="soldado-tipo"></select>
                </label>
                <label>
                    Nome:
                    <input id="soldado-nome" type="text" maxlength="40" placeholder="Opcional">
                </label>
                <button type="submit">Adicionar Soldado</button>
            </form>
        </section>
    </section>
    <!-- MAGIAS -->
    <section id="magias" class="tab-content">
        <h2>Banco de Magias</h2>
        <div class="mago-seletor" id="magoSeletorDiv">
            <span class="label">Vincular magias a:</span>
            <span id="magoSeletor"></span>
        </div>
        <form class="add-form" id="add-magia-form">
            <label>
                Selecionar do Livro:
                <select id="dropdown-magias-livro">
                    <option value="">-- Escolha uma magia --</option>
                </select>
            </label>
            <label>
                Magia:
                <input id="nova-magia-nome" type="text" maxlength="32" placeholder="Nome da Magia">
            </label>
            <label>
                Escola:
                <select id="nova-magia-escola">
                    <option>Chronomancer</option><option>Elementalist</option>
                    <option>Enchanter</option><option>Illusionist</option>
                    <option>Necromancer</option><option>Sigilist</option>
                    <option>Soothsayer</option><option>Summoner</option>
                    <option>Thaumaturge</option><option>Witch</option>
                </select>
            </label>
            <label>
                Custo Base:
                <input id="nova-magia-custo" type="number" min="1" max="20" value="8">
            </label>
            <label>
                Descrição:
                <input id="nova-magia-desc" type="text" maxlength="120" placeholder="Descrição da magia">
            </label>
            <label>
                Efeito Completo:
                <textarea id="nova-magia-completo" maxlength="1000" placeholder="Texto completo do efeito" rows="2"></textarea>
            </label>
            <button type="submit">Adicionar Magia</button>
        </form>
        <ul id="banco-magias-lista" class="magias-list"></ul>
        <div id="magiasDoMagoDiv"></div>
    </section>
    <!-- ITENS -->
    <section id="itens" class="tab-content">
        <h2>Banco de Itens</h2>
        <form class="add-form" id="add-item-form">
            <label>
                Item:
                <input id="novo-item-nome" type="text" maxlength="32" placeholder="Nome do Item">
            </label>
            <label>
                Descrição:
                <input id="novo-item-desc" type="text" maxlength="120" placeholder="Descrição do item">
            </label>
            <label>
                Modificadores (ex: fight:+2, armor:+1, hp:+5):
                <input id="novo-item-mods" type="text" maxlength="40" placeholder="fight:+2, armor:+1">
            </label>
            <label>
                Efeito Completo:
                <textarea id="novo-item-efeito" maxlength="800" placeholder="Texto completo do efeito" rows="2"></textarea>
            </label>
            <button type="submit">Adicionar Item</button>
        </form>
        <ul id="banco-itens-lista" class="itens-list"></ul>
    </section>
    <!-- NOTAS -->
    <section id="notas" class="tab-content">
        <h2>Anotações da Warband</h2>
        <textarea class="notes-box" id="notas-box" placeholder="Anote estratégias, progresso, tesouros, eventos..."></textarea>
    </section>
</main>
<script>
// --- Magias do livro base (trecho, adicione mais conforme necessário) ---
const magiasLivro = [
    {nome: "Absorb Knowledge", escola: "Sigilist", custo_base: 8, descricao: "Permite ao mago ganhar XP extra lendo grimórios.", completo: "O mago pode gastar uma ação para ler um grimório não usado, ganhando 50 XP. O grimório é removido após o uso."},
    {nome: "Awaken Construct", escola: "Enchanter", custo_base: 8, descricao: "Traz à vida um constructo preparado.", completo: "O mago pode animar um constructo previamente preparado, usando um Grimório de Constructo. O constructo age como aliado."},
    {nome: "Bone Dart", escola: "Necromancer", custo_base: 8, descricao: "Projétil mágico de osso que causa dano.", completo: "Alcance 24\". Causa dano igual a um ataque de força +5."},
    {nome: "Bridge", escola: "Sigilist", custo_base: 8, descricao: "Cria uma ponte mágica temporária.", completo: "Cria uma ponte de até 6\" de comprimento e 2\" de largura. Dura até o fim do turno seguinte."},
    {nome: "Elemental Bolt", escola: "Elementalist", custo_base: 10, descricao: "Projétil elemental poderoso: causa dano à distância.", completo: "Alcance 24\". Dano: Força +8. Ataque mágico direto."},
    {nome: "Grenade", escola: "Elementalist", custo_base: 10, descricao: "Arremessa uma bola de fogo em área.", completo: "Alcance 12\". Área: 1.5\" de raio. Todas as miniaturas atingidas sofrem um ataque de força +3."},
    {nome: "Push", escola: "Thaumaturge", custo_base: 8, descricao: "Empurra o alvo para trás.", completo: "Alcance 16\". Alvo empurrado 6\" em linha reta, podendo cair de bordas e sofrer dano."},
    {nome: "Teleport", escola: "Chronomancer", custo_base: 12, descricao: "Teleporta o mago para qualquer local visível.", completo: "O mago pode se teletransportar para qualquer local visível a até 16\"."}
    // ...adicione todas as magias do livro aqui!
];
// Itens do livro base (exemplo com modificadores)
const itensLivro = [
    {nome: "Staff of Power", descricao: "Aumenta poder mágico.", mods: "will:+1", efeito: "O usuário recebe +1 em testes de Will ao lançar magias."},
    {nome: "Magic Sword", descricao: "Espada encantada (+1 Fight)", mods: "fight:+1", efeito: "O portador recebe +1 no atributo Fight enquanto empunhar."},
    {nome: "Magic Bow", descricao: "Arco mágico (+1 Shoot)", mods: "shoot:+1", efeito: "O portador recebe +1 no atributo Shoot enquanto empunhar."},
    {nome: "Magic Armor", descricao: "Armadura encantada (+1 Armor)", mods: "armor:+1", efeito: "O portador recebe +1 no atributo Armor enquanto vestir."},
    {nome: "Magic Shield", descricao: "Escudo mágico (+1 Armor)", mods: "armor:+1", efeito: "O portador recebe +1 em Armor enquanto portar este escudo."},
    {nome: "Potion of Healing", descricao: "Recupera até 5 HP ao ser consumida.", mods: "hp:+5", efeito: "Recupere até 5 pontos de vida ao usar esta poção."},
    {nome: "Potion of Invisibility", descricao: "Faz o usuário ficar invisível até atacar.", mods: "", efeito: "O usuário torna-se invisível até atacar, lançar magia, ou ser ferido."}
    // ...adicione mais itens do livro aqui!
];
// Soldados padrões e separação normais/elite
const SOLDADOS_NORMAIS = [
    "Thief","Thug","War Dog"
];
const SOLDADOS_ELITES = [
    "Archer","Barbarian","Crossbowman","Infantryman","Knight","Man-at-Arms","Marksman","Ranger","Templar","Tracker","Treasure Hunter","Apothecary","Crowmaster","Pack Mule","Trap Expert","Witch Doctor"
];
const SOLDADOS_PADRAO = {
  "Archer":          { move:6, fight:0, shoot:+2, armor:11, will:0, hp:10 },
  "Barbarian":       { move:6, fight:+4, shoot:0, armor:10, will:0, hp:12 },
  "Crossbowman":     { move:6, fight:0, shoot:+2, armor:11, will:0, hp:10 },
  "Infantryman":     { move:6, fight:+2, shoot:0, armor:12, will:0, hp:12 },
  "Knight":          { move:6, fight:+3, shoot:0, armor:14, will:0, hp:12 },
  "Man-at-Arms":     { move:6, fight:+3, shoot:0, armor:13, will:0, hp:12 },
  "Marksman":        { move:6, fight:0, shoot:+3, armor:11, will:0, hp:10 },
  "Ranger":          { move:7, fight:+2, shoot:+2, armor:11, will:0, hp:12 },
  "Templar":         { move:6, fight:+4, shoot:0, armor:12, will:0, hp:12 },
  "Thief":           { move:7, fight:+1, shoot:0, armor:10, will:0, hp:10 },
  "Tracker":         { move:7, fight:+1, shoot:+2, armor:11, will:0, hp:10 },
  "Treasure Hunter": { move:7, fight:+3, shoot:0, armor:12, will:0, hp:12 },
  "Thug":            { move:6, fight:+2, shoot:0, armor:10, will:0, hp:10 },
  "War Dog":         { move:8, fight:+1, shoot:0, armor:10, will:0, hp:8 },
  "Apothecary":      { move:6, fight:0, shoot:0, armor:10, will:0, hp:10 },
  "Crowmaster":      { move:6, fight:0, shoot:0, armor:10, will:0, hp:10 },
  "Pack Mule":       { move:6, fight:0, shoot:0, armor:10, will:0, hp:10 },
  "Trap Expert":     { move:7, fight:0, shoot:0, armor:10, will:0, hp:10 },
  "Witch Doctor":    { move:6, fight:0, shoot:0, armor:10, will:0, hp:10 }
};
const SOLDADOS_NORMAIS_SET = new Set(SOLDADOS_NORMAIS);
const SOLDADOS_ELITES_SET = new Set(SOLDADOS_ELITES);

function custoMagia(magia, escolaJogador) {
    if (!escolaJogador) return magia.custo_base;
    if (magia.escola === escolaJogador) return magia.custo_base;
    if (ALINHADAS[escolaJogador]?.includes(magia.escola)) return magia.custo_base + 2;
    if (OPOSTAS[escolaJogador]?.includes(magia.escola)) return magia.custo_base + 6;
    return magia.custo_base + 4;
}
function alinDesc(magia, escola) {
    if (!escola || magia.escola === escola) return "Principal";
    if (ALINHADAS[escola]?.includes(magia.escola)) return "Alinhada";
    if (OPOSTAS[escola]?.includes(magia.escola)) return "Oposta";
    return "Neutra";
}
// Modificadores de itens: retorna objeto {fight:+1,...}
function parseMods(str) {
    let mods = {};
    str.split(",").forEach(m=>{
        let [chave, valor] = m.split(":").map(s=>s.trim());
        if(chave && valor && !isNaN(Number(valor))) mods[chave] = Number(valor);
    });
    return mods;
}
function aplicarModStats(stats, mods) {
    let novo = {...stats};
    for(const atr in mods) {
        if(novo.hasOwnProperty(atr)) novo[atr] = (Number(novo[atr])||0) + Number(mods[atr]);
    }
    return novo;
}
function aplicarItensStats(stats, itens) {
    let totalMods = {};
    (itens||[]).forEach(item=>{
        if(item.modsObj) {
            for(const k in item.modsObj) totalMods[k] = (totalMods[k]||0) + item.modsObj[k];
        }
    });
    return aplicarModStats(stats,totalMods);
}

function contarSoldados() {
    let norm = 0, elite = 0;
    for(const p of personagens) {
        if(p.tipo==="Soldado") {
            if(SOLDADOS_NORMAIS_SET.has(p.subTipo)) norm++;
            else if(SOLDADOS_ELITES_SET.has(p.subTipo)) elite++;
        }
    }
    return {norm, elite};
}
function soldadoLimiteAtingido(tipo) {
    let {norm, elite} = contarSoldados();
    if(SOLDADOS_NORMAIS_SET.has(tipo)) return norm>=4;
    if(SOLDADOS_ELITES_SET.has(tipo)) return elite>=4;
    return true;
}

function salvarLS() {
    localStorage.setItem('warband_personagens', JSON.stringify(personagens));
    localStorage.setItem('warband_banco_magias', JSON.stringify(bancoMagias));
    localStorage.setItem('warband_banco_itens', JSON.stringify(bancoItens));
    localStorage.setItem('warband_notas', notas.value);
    localStorage.setItem('warband_vinculo_mago', selectedMagoId !== null ? selectedMagoId : "");
}
function carregarLS() {
    personagens = JSON.parse(localStorage.getItem('warband_personagens')||'[]');
    bancoMagias = JSON.parse(localStorage.getItem('warband_banco_magias')||'[]');
    bancoItens = JSON.parse(localStorage.getItem('warband_banco_itens')||'[]');
    notas.value = localStorage.getItem('warband_notas')||'';
    selectedMagoId = localStorage.getItem('warband_vinculo_mago');
    if(selectedMagoId==="") selectedMagoId = null;
}
let personagens = [];
let bancoMagias = magiasLivro.slice(0,3); // Começa só com as 3 primeiras, pode aumentar
let bancoItens = itensLivro.slice(0,3);   // Começa só com 3 itens
const notas = document.getElementById('notas-box');
let selectedMagoId = null;

carregarLS();

function showTab(tab) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tabEl => tabEl.classList.remove('active'));
    document.querySelector(`nav button[onclick*="${tab}"]`).classList.add('active');
    document.getElementById(tab).classList.add('active');
    if(tab==='magias') {
        renderMagoSeletor();
        renderBancoMagias();
        renderMagiasDoMago();
    }
    if(tab==='itens') renderBancoItens();
}
window.showTab = showTab;

function renderPersonagens() {
    const magoAprendizLista = document.getElementById('mago-aprendiz-lista');
    const soldadoLista = document.getElementById('soldado-lista');
    magoAprendizLista.innerHTML = '';
    soldadoLista.innerHTML = '';
    let {norm, elite} = contarSoldados();
    personagens.forEach((pers, idx) => {
        const card = personagemCard(pers, idx, norm, elite);
        if (pers.tipo === 'Mago' || pers.tipo === 'Aprendiz') {
            if(selectedMagoId!==null && parseInt(selectedMagoId,10)===idx) {
                card.classList.add('personagem-destacado');
            }
            magoAprendizLista.appendChild(card);
        } else {
            soldadoLista.appendChild(card);
        }
    });
    renderSoldadoAlert();
}

function renderSoldadoAlert() {
    let {norm, elite} = contarSoldados();
    let alert = "";
    if(norm >= 4) alert += "Limite de soldados normais atingido! ";
    if(elite >= 4) alert += "Limite de soldados elite atingido!";
    document.getElementById('soldado-limit-alert').textContent = alert;
}

function personagemCard(pers, idx, norm, elite) {
    const li = document.createElement('li');
    li.className = "person-card";
    // Itens: calcula modificadores
    let itens = pers.itens||[];
    itens.forEach(i=>{ if(i.mods && !i.modsObj) i.modsObj = parseMods(i.mods); });
    let statsVis = aplicarItensStats(pers.stats, itens);
    // Badge limite
    let badge = "";
    if(pers.tipo==="Soldado" && pers.subTipo) {
        if(SOLDADOS_NORMAIS_SET.has(pers.subTipo))
            badge = `<span class="badge-limit badge-norm" title="Soldado Normal">NORMAL</span>`;
        if(SOLDADOS_ELITES_SET.has(pers.subTipo))
            badge = `<span class="badge-limit badge-el" title="Soldado Elite">ELITE</span>`;
    }
    // Magias
    let magiasHtml = pers.magias?.length ? pers.magias.map((m,i)=>(
        `<li>
            <span class="magia-tooltip">
                ${m.nome}
                <span class="tooltiptext">
                    <b>${m.nome}</b> <span style="color:#aaa;">[${m.escola}]</span><br>
                    <b>Descrição:</b> ${m.descricao || 'Sem descrição.'}<br>
                    <b>Custo p/ este personagem:</b> ${typeof m.custo_base !== 'undefined' && pers.escola ? custoMagia(m, pers.escola) : '?'} 
                    <span class="small">(${alinDesc(m, pers.escola)})</span><br>
                    <b>Custo base:</b> ${m.custo_base || '-'}<br>
                    <b>Efeito completo:</b> ${m.completo||'-'}
                </span>
                ${typeof m.custo_base !== 'undefined' && pers.escola ? `<span class="small">(${custoMagia(m, pers.escola)})</span>` : ""}
            </span>
            <button class="remove-btn" title="Remover magia" onclick="removerMagia(${idx},${i})">×</button>
        </li>`
    )).join("") : "<li>-</li>";
    let magiasAddHtml = bancoMagias.map((m,mi)=>
        `<button class="magia-add-btn" title="Equipar ${m.nome}" onclick="adicionarMagia(${idx},${mi})">+${m.nome}</button>`
    ).join(" ");
    // Itens
    let itensHtml = itens.length ? itens.map((i,j)=>`<li>
        <span class="item-tooltip" tabindex="0">
            ${i.nome}
            <span class="tooltiptext">
                <b>${i.nome}</b><br>
                <b>Descrição:</b> ${i.descricao||""}<br>
                <b>Mods:</b> ${i.mods||"-"}<br>
                <b>Efeito:</b> ${i.efeito||"-"}
            </span>
        </span>
        <button class="remove-btn" title="Remover item" onclick="removerItem(${idx},${j})">×</button>
    </li>`).join("") : "<li>-</li>";
    let itensAddHtml = bancoItens.map((i,ii)=>
        `<button class="item-add-btn" title="Equipar ${i.nome}" onclick="adicionarItem(${idx},${ii})">+${i.nome}</button>`
    ).join(" ");
    li.innerHTML = `
        <div class="person-header">
            <span class="${pers.tipo==='Mago' ? 'tipo-mago' : pers.tipo==='Aprendiz' ? 'tipo-aprendiz' : 'tipo-soldado'}">${pers.tipo}${pers.subTipo ? " ("+pers.subTipo+")" : ""}</span>
            ${badge}
            <input class="name-value" value="${pers.nome}" onchange="editarNome(${idx},this.value)" />
            ${pers.escola ? `<span style="color:#aaa; margin-left:10px">[${pers.escola}]</span>` : ""}
            <button class="remove-btn" onclick="removerPersonagem(${idx})" title="Remover personagem">×</button>
        </div>
        <div class="stats-line">
            <span class="stat-label">HP:</span>
            <span class="hp-box">
                <button class="hp-btn" onclick="alterarHP(${idx},-1)">-</button>
                <input class="hp-value" type="number" min="0" value="${pers.hp}" onchange="setHP(${idx},this.value)">
                <button class="hp-btn" onclick="alterarHP(${idx},1)">+</button>
            </span>
            <span class="stat-label">Move:</span> <span class="stat-value">${statsVis.move}</span>
            <span class="stat-label">Fight:</span> <span class="stat-value">${statsVis.fight>=0?'+':''}${statsVis.fight}</span>
            <span class="stat-label">Shoot:</span> <span class="stat-value">${statsVis.shoot>=0?'+':''}${statsVis.shoot}</span>
            <span class="stat-label">Armor:</span> <span class="stat-value">${statsVis.armor}</span>
            <span class="stat-label">Will:</span> <span class="stat-value">${statsVis.will>=0?'+':''}${statsVis.will}</span>
            ${pers.nivel !== undefined ? `<span class="stat-label">Nível:</span> <span class="stat-value">${pers.nivel}</span>` : ""}
        </div>
        <div>
            <span class="label">Magias:</span>
            <ul class="magias-list">${magiasHtml}</ul>
            <div class="actions-row">${magiasAddHtml}</div>
        </div>
        <div>
            <span class="label">Itens:</span>
            <ul class="itens-list">${itensHtml}</ul>
            <div class="actions-row">${itensAddHtml}</div>
        </div>
    `;
    return li;
}
window.adicionarMagia = function(idx, magiaIdx) {
    const m = {...bancoMagias[magiaIdx]};
    personagens[idx].magias = personagens[idx].magias || [];
    if (!personagens[idx].magias.find(mm => mm.nome === m.nome)) {
        personagens[idx].magias.push(m);
        salvarLS(); renderPersonagens(); renderMagiasDoMago();
    }
}
window.removerMagia = function(idx, magiaIdx) {
    personagens[idx].magias.splice(magiaIdx,1);
    salvarLS(); renderPersonagens(); renderMagiasDoMago();
}
window.adicionarItem = function(idx, itemIdx) {
    const i = {...bancoItens[itemIdx]};
    if(i.mods && typeof i.modsObj==="undefined") i.modsObj = parseMods(i.mods);
    personagens[idx].itens = personagens[idx].itens || [];
    if (!personagens[idx].itens.find(ii => ii.nome === i.nome)) {
        personagens[idx].itens.push(i);
        salvarLS(); renderPersonagens();
    }
}
window.removerItem = function(idx, itemIdx) {
    personagens[idx].itens.splice(itemIdx,1);
    salvarLS(); renderPersonagens();
}
window.editarNome = function(idx, value) {
    personagens[idx].nome = value.trim();
    salvarLS();
}
window.alterarHP = function(idx, delta) {
    personagens[idx].hp = Math.max(0, personagens[idx].hp + delta);
    salvarLS(); renderPersonagens();
}
window.setHP = function(idx, value) {
    personagens[idx].hp = Math.max(0, parseInt(value) || 0);
    salvarLS();
}
window.adicionarMago = function() {
    if (personagens.find(p=>p.tipo==="Mago")) {
        alert("Só pode haver um mago na warband!");
        return;
    }
    personagens.push({
        tipo:"Mago",
        nome:"Mago",
        escola:"Elementalist",
        hp:14,
        nivel:1,
        stats: {move:6,fight:+2,shoot:0,armor:10,will:+4},
        magias:[],
        itens:[]
    });
    salvarLS();
    renderPersonagens();
    renderMagoSeletor();
    renderMagiasDoMago();
};
window.adicionarAprendiz = function() {
    if (personagens.find(p=>p.tipo==="Aprendiz")) {
        alert("Só pode haver um aprendiz na warband!");
        return;
    }
    personagens.push({
        tipo:"Aprendiz",
        nome:"Aprendiz",
        escola:"Elementalist",
        hp:10,
        nivel:0,
        stats: {move:6,fight:+1,shoot:0,armor:10,will:+2},
        magias:[],
        itens:[]
    });
    salvarLS();
    renderPersonagens();
    renderMagoSeletor();
    renderMagiasDoMago();
};

// Preenche dropdown de soldados padrão com separação e bloqueio por limite
function renderSoldadoDropdown() {
    let soldadoSel = document.getElementById('soldado-tipo');
    let {norm, elite} = contarSoldados();
    let normDisabled = norm>=4;
    let eliteDisabled = elite>=4;
    let html = "";
    html += `<optgroup label="Normais">`;
    for(const k of SOLDADOS_NORMAIS) {
        html += `<option value="${k}"${normDisabled?" disabled":""}>${k}</option>`;
    }
    html += `</optgroup>`;
    html += `<optgroup label="Elites">`;
    for(const k of SOLDADOS_ELITES) {
        html += `<option value="${k}"${eliteDisabled?" disabled":""}>${k}</option>`;
    }
    html += `</optgroup>`;
    soldadoSel.innerHTML = html;
}
renderSoldadoDropdown();

document.getElementById('add-soldado-form').onsubmit = function(e) {
    e.preventDefault();
    const tipo = "Soldado";
    const subTipo = document.getElementById('soldado-tipo').value;
    const nome = document.getElementById('soldado-nome').value.trim() || subTipo;
    if(soldadoLimiteAtingido(subTipo)) {
        alert(`Limite atingido para este tipo de soldado.`);
        return;
    }
    const statsBase = SOLDADOS_PADRAO[subTipo];
    personagens.push({
        tipo,
        nome,
        subTipo,
        escola: undefined,
        hp: statsBase.hp,
        nivel: undefined,
        stats: {
            move: statsBase.move,
            fight: statsBase.fight,
            shoot: statsBase.shoot,
            armor: statsBase.armor,
            will: statsBase.will
        },
        magias: [],
        itens: []
    });
    salvarLS();
    renderPersonagens();
    renderSoldadoDropdown();
    this.reset();
};

window.removerPersonagem = function(idx) {
    if(confirm("Remover personagem?")) {
        personagens.splice(idx,1);
        if(selectedMagoId!==null && parseInt(selectedMagoId,10)===idx) {
            selectedMagoId = null;
        }
        salvarLS(); renderPersonagens(); renderMagoSeletor(); renderMagiasDoMago(); renderSoldadoDropdown();
    }
}
function renderBancoMagias() {
    const ul = document.getElementById('banco-magias-lista');
    ul.innerHTML = bancoMagias.length ? bancoMagias.map((m, idx)=>`
        <li>
            <span class="magia-tooltip">
                <b>${m.nome}</b> <span style="color:#aaa;">[${m.escola}]</span>
                <span class="tooltiptext">
                    <b>${m.nome}</b> <span style="color:#aaa;">[${m.escola}]</span><br>
                    <b>Descrição:</b> ${m.descricao || "-"}<br>
                    <b>Custo base:</b> ${m.custo_base}<br>
                    <b>Efeito completo:</b> ${m.completo||'-'}
                </span>
            </span>
            ${
                selectedMagoId!==null
                ? `<button class="magia-add-btn" title="Vincular ao mago/aprendiz" onclick="vincularMagiaAoMago(${idx})">+Vincular ao selecionado</button>`
                : ""
            }
            <button class="remove-btn" onclick="removerBancoMagia(${idx})" title="Remover magia">×</button>
        </li>
    `).join("") : "<li style='color:#aaa;'>Nenhuma magia cadastrada.</li>";
}
window.removerBancoMagia = function(idx) {
    bancoMagias.splice(idx,1); salvarLS(); renderBancoMagias();
}
document.getElementById('add-magia-form').onsubmit = function(e) {
    e.preventDefault();
    const nome = document.getElementById('nova-magia-nome').value.trim();
    const escola = document.getElementById('nova-magia-escola').value;
    const custo_base = parseInt(document.getElementById('nova-magia-custo').value,10) || 8;
    const descricao = document.getElementById('nova-magia-desc').value.trim();
    const completo = document.getElementById('nova-magia-completo').value.trim();
    if(nome && escola) {
        if(!bancoMagias.find(m=>m.nome===nome)) {
            bancoMagias.push({nome, escola, custo_base, descricao, completo});
            salvarLS();
        }
        this.reset();
        renderBancoMagias();
    }
}
function renderBancoItens() {
    const ul = document.getElementById('banco-itens-lista');
    ul.innerHTML = bancoItens.length ? bancoItens.map((i, idx)=>`
        <li>
            <span class="item-tooltip">
                <b>${i.nome}</b>
                <span class="tooltiptext">
                    <b>${i.nome}</b><br>
                    <b>Descrição:</b> ${i.descricao||""}<br>
                    <b>Mods:</b> ${i.mods||"-"}<br>
                    <b>Efeito:</b> ${i.efeito||"-"}
                </span>
            </span>
            <button class="item-add-btn" onclick="adicionarItemBanco(${idx})">+Adicionar ao personagem</button>
            <button class="remove-btn" onclick="removerBancoItem(${idx})" title="Remover item">×</button>
        </li>
    `).join("") : "<li style='color:#aaa;'>Nenhum item cadastrado.</li>";
}
window.removerBancoItem = function(idx) {
    bancoItens.splice(idx,1); salvarLS(); renderBancoItens();
}
window.adicionarItemBanco = function(idxBancoItem){
    alert("Para adicionar um item, clique no botão '+[nome]' dentro do card do personagem desejado.");
};
document.getElementById('add-item-form').onsubmit = function(e) {
    e.preventDefault();
    const nome = document.getElementById('novo-item-nome').value.trim();
    const descricao = document.getElementById('novo-item-desc').value.trim();
    const mods = document.getElementById('novo-item-mods').value.trim();
    const efeito = document.getElementById('novo-item-efeito').value.trim();
    if(nome) {
        if(!bancoItens.find(i=>i.nome===nome)) {
            bancoItens.push({nome, descricao, mods, efeito, modsObj: parseMods(mods)});
            salvarLS();
        }
        this.reset();
        renderBancoItens();
    }
}
notas.oninput = function() { salvarLS(); }
renderPersonagens();
renderBancoMagias();
renderBancoItens();

// ------ Magias do livro no dropdown ------
function renderDropdownMagiasLivro() {
    const sel = document.getElementById('dropdown-magias-livro');
    sel.innerHTML = `<option value="">-- Escolha uma magia --</option>` +
        magiasLivro.map((m, idx) =>
            `<option value="${idx}">
                ${m.nome} [${m.escola}] - ${m.descricao ? m.descricao.substring(0,40) : ""}
            </option>`
        ).join("");
}
renderDropdownMagiasLivro();

document.getElementById('dropdown-magias-livro').onchange = function() {
    const idx = this.value;
    if (idx === "") {
        document.getElementById('nova-magia-nome').value = "";
        document.getElementById('nova-magia-escola').value = ESCOLAS[0];
        document.getElementById('nova-magia-custo').value = "";
        document.getElementById('nova-magia-desc').value = "";
        document.getElementById('nova-magia-completo').value = "";
        return;
    }
    const magia = magiasLivro[idx];
    document.getElementById('nova-magia-nome').value = magia.nome;
    document.getElementById('nova-magia-escola').value = magia.escola;
    document.getElementById('nova-magia-custo').value = magia.custo_base;
    document.getElementById('nova-magia-desc').value = magia.descricao || "";
    document.getElementById('nova-magia-completo').value = magia.completo || "";
}

// ----------- Vincular magias ao mago/aprendiz -----------
function renderMagoSeletor() {
    const seletor = document.getElementById('magoSeletor');
    // Listar apenas personagens do tipo Mago ou Aprendiz
    let magos = [];
    personagens.forEach((pers, idx) => {
        if(pers.tipo==="Mago" || pers.tipo==="Aprendiz") magos.push({nome: pers.nome, idx, tipo: pers.tipo});
    });
    if(magos.length === 0) {
        seletor.innerHTML = `<span style="color:#aaa;">Cadastre um mago ou aprendiz para vincular magias.</span>`;
        selectedMagoId = null;
        salvarLS();
        return;
    }
    seletor.innerHTML = magos.map(m => 
        `<span class="mago-link${selectedMagoId!==null && parseInt(selectedMagoId,10)===m.idx ? " active" : ""}" onclick="selecionarMago(${m.idx})">${m.nome} [${m.tipo}]</span>`
    ).join(" | ");
}
window.selecionarMago = function(idx) {
    selectedMagoId = idx;
    salvarLS();
    renderMagoSeletor();
    renderPersonagens();
    renderMagiasDoMago();
}

// Adiciona magia do banco ao mago/aprendiz selecionado
window.vincularMagiaAoMago = function(idxBancoMagia) {
    if(selectedMagoId===null) {
        alert("Selecione um mago ou aprendiz para vincular magias.");
        return;
    }
    const mago = personagens[selectedMagoId];
    if(!mago.magias) mago.magias = [];
    const magia = {...bancoMagias[idxBancoMagia]};
    if (!mago.magias.find(m=>m.nome===magia.nome)) {
        mago.magias.push(magia);
        salvarLS();
        renderPersonagens();
        renderMagiasDoMago();
    }
}

// Visualiza as magias do mago/aprendiz selecionado
function renderMagiasDoMago() {
    const div = document.getElementById('magiasDoMagoDiv');
    if(selectedMagoId===null || !personagens[selectedMagoId]) {
        div.innerHTML = "";
        return;
    }
    const mago = personagens[selectedMagoId];
    div.innerHTML = `<h3>Magias de ${mago.nome} [${mago.tipo}]</h3>
        <ul class="magias-list">${
            (mago.magias && mago.magias.length)
            ? mago.magias.map((m,i)=>`
                <li>
                    <span class="magia-tooltip">
                        ${m.nome}
                        <span class="tooltiptext">
                            <b>${m.nome}</b> <span style="color:#aaa;">[${m.escola}]</span><br>
                            <b>Descrição:</b> ${m.descricao || 'Sem descrição.'}<br>
                            <b>Custo p/ este personagem:</b> ${typeof m.custo_base !== 'undefined' && mago.escola ? custoMagia(m, mago.escola) : '?'} 
                            <span class="small">(${alinDesc(m, mago.escola)})</span><br>
                            <b>Custo base:</b> ${m.custo_base || '-'}<br>
                            <b>Efeito completo:</b> ${m.completo||'-'}
                        </span>
                    </span>
                    <button class="remove-btn" onclick="removerMagiaDireto(${selectedMagoId},${i})" title="Remover magia">×</button>
                </li>
            `).join("")
            : "<li style='color:#aaa;'>Nenhuma magia vinculada.</li>"
        }</ul>`;
}
window.removerMagiaDireto = function(idxMago, idxMagia) {
    personagens[idxMago].magias.splice(idxMagia,1);
    salvarLS();
    renderPersonagens();
    renderMagiasDoMago();
}

// Adiciona os itens do livro ao banco inicial (garante que só adiciona se não existir)
for(const i of itensLivro){
    if(!bancoItens.find(j=>j.nome===i.nome)){
        bancoItens.push({...i, modsObj: parseMods(i.mods)});
    }
}

notas.oninput = function() { salvarLS(); }
renderPersonagens();
renderMagoSeletor();
renderMagiasDoMago();
renderBancoMagias();
renderBancoItens();
</script>
</body>
</html>
